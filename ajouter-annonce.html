<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#22c55e" />
  <title>PetBook — Publier une annonce</title>

  <!-- Thème global -->
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="icon" type="image/png" href="images/favicon.png" />
  <link rel="apple-touch-icon" href="images/logo-app.png" />

  <!-- Netlify Identity (si tu gardes l’auth plus tard) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Compléments légers au thème global */
    :root{--brand:#22c55e;--ink:#0f172a;--muted:#64748b;--border:#e5e7eb;--danger:#dc2626}
    .page-title{font-size:clamp(20px,3vw,28px);font-weight:900;letter-spacing:.2px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 768px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:14px;margin-bottom:6px;color:#334155}
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="url"],input[type="file"],select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:inherit
    }
    textarea{min-height:140px;resize:vertical}
    .hint{font-size:12px;color:#64748b;margin-top:6px}
    .divider{height:1px;background:var(--border);margin:18px 0}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--border);font-weight:800;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.secondary{background:#fff;border-color:var(--border);color:var(--ink)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .note{background:#f8fafc;border:1px dashed var(--border);padding:12px;border-radius:12px;color:#334155}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .hidden{display:none !important}

    /* Alignement checkbox + liens */
    .consent{display:flex;align-items:flex-start;gap:10px}
    .consent input{margin-top:2px}
    .consent a{font-weight:800;text-decoration:underline;color:#22c55e}
    .status{margin-top:10px;font-size:.95rem}
    .status.ok{color:#065f46}.status.err{color:#b91c1c}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="container nav">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="Logo PetBook" />
        PetBook
      </a>
      <nav class="links">
        <a href="annonces.html">Voir les annonces</a>
        <a href="pet-alert.html">Pet Alert</a>
        <a href="ajouter-annonce.html" class="btn primary">Publier</a>

        <!-- Auth UI (optionnel) -->
        <a id="link-account" href="compte.html" class="btn hidden">Mon compte</a>
        <button id="btn-login" class="btn">Connexion</button>
        <button id="btn-logout" class="btn hidden">Se déconnecter</button>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section class="section">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h1 class="page-title">Publier une annonce</h1>
      <a href="pet-alert.html" class="btn danger">⚠️ PetAlert / Urgences</a>
    </div>
  </section>

  <main class="section">
    <div class="container">
      <!-- FORMULAIRE (côté client → Supabase) -->
      <form id="annonce-form" class="card" autocomplete="on">
        <div class="note" style="margin-bottom:14px;">
          <strong>Info :</strong> La publication est soumise à vérification. Les annonces validées apparaîtront sur <a href="annonces.html">la page Annonces</a>.
        </div>

        <!-- ===== Informations générales ===== -->
        <h3 style="margin:6px 0 10px;font-weight:800;color:#0f172a">Informations générales</h3>
        <div class="grid">
          <div>
            <label for="type">Type d’annonce *</label>
            <select id="type" required>
              <option value="" disabled selected>Choisir…</option>
              <option value="Vente/Adoption">Vente / Adoption</option>
              <option value="Accessoires">Accessoires</option>
              <option value="Services">Services professionnels</option>
            </select>
            <div class="hint">Choisissez le type pour afficher les bons champs.</div>
          </div>

          <div>
            <label for="title">Titre de l’annonce *</label>
            <input id="title" type="text" placeholder="Ex. Chiot Border Collie / Aquarium complet / Toiletteur à Lausanne…" required>
          </div>

          <div>
            <label for="categorie" id="label-categorie">Catégorie (Niveau 1) *</label>
            <select id="categorie" required disabled>
              <option value="" disabled selected>Choisir un type d’abord</option>
            </select>
            <div class="hint" id="hint-categorie">Ex. Vente : Animaux de compagnie ou Animaux de ferme.</div>
          </div>

          <div>
            <label for="famille" id="label-famille">Espèce (Niveau 2) *</label>
            <select id="famille" required disabled>
              <option value="" disabled selected>Choisir une catégorie d’abord</option>
            </select>
            <div class="hint" id="hint-famille">Ex. Chien / Chat / Bovin / Apiculture…</div>
          </div>

          <div>
            <label for="detail" id="label-detail">Accessoire (Niveau 3)</label>
            <select id="detail" disabled>
              <option value="" disabled selected>Choisir une famille d’abord</option>
            </select>
            <div class="hint" id="hint-detail">S’active pour Accessoires (ex. Niches, Ruches…).</div>
          </div>

          <div>
            <label for="lieu">Localisation (Commune) *</label>
            <input id="lieu" type="text" placeholder="Ex. Montreux" required>
          </div>

          <div>
            <label for="canton">Canton *</label>
            <select id="canton" required>
              <option value="" disabled selected>Choisir…</option>
              <option>VD</option><option>VS</option><option>GE</option><option>FR</option><option>NE</option>
              <option>JU</option><option>BE</option><option>ZH</option><option>TI</option><option>AG</option>
              <option>BL</option><option>BS</option><option>GR</option><option>GL</option><option>SG</option>
              <option>SH</option><option>SO</option><option>SZ</option><option>TG</option><option>UR</option>
              <option>AI</option><option>AR</option><option>LU</option><option>NW</option><option>OW</option>
            </select>
          </div>

          <div>
            <label for="race">Race / Espèce (si applicable)</label>
            <input id="race" type="text" placeholder="Ex. British Shorthair, Valais Blacknose, Python regius…">
          </div>

          <div>
            <label for="age">Âge (approx.)</label>
            <input id="age" type="text" placeholder="Ex. 3 mois, 2 ans, 2024…">
          </div>
        </div>

        <div class="divider"></div>

        <!-- ===== Description ===== -->
        <h3 style="margin:6px 0 10px;font-weight:800;color:#0f172a">Description</h3>
        <div>
          <textarea id="desc" placeholder="Décris précisément : santé/état, vaccins/garantie, conditions, accessoires inclus, etc." required></textarea>
        </div>

        <div class="divider"></div>

        <!-- ===== Tarif ===== -->
        <h3 style="margin:6px 0 10px;font-weight:800;color:#0f172a">Tarif</h3>
        <div class="grid" style="align-items:end">
          <div>
            <label for="prix">Prix (CHF)</label>
            <input id="prix" type="number" min="0" step="1" placeholder="Ex. 250">
            <div class="hint">Laisse vide si « Gratuit » est coché, ou si c’est un service « sur devis ».</div>
          </div>
          <div class="row">
            <label class="row"><input type="checkbox" id="gratuit" /> Gratuit</label>
            <label class="row"><input type="checkbox" id="surdevis" /> Service / prix sur devis</label>
          </div>
        </div>

        <div class="divider"></div>

        <!-- ===== Photos / Médias ===== -->
        <h3 style="margin:6px 0 10px;font-weight:800;color:#0f172a">Photos / Médias</h3>
        <div class="grid">
          <div>
            <label for="photos">Ajouter des photos (jusqu’à 6)</label>
            <input id="photos" type="file" accept="image/*" multiple>
            <div class="hint">Pour l’instant, les photos ne sont pas encore envoyées. (On le fera à l’étape suivante.)</div>
          </div>
          <div>
            <label for="video">Lien vidéo (optionnel)</label>
            <input id="video" type="url" placeholder="https://... (YouTube, TikTok, etc.)">
          </div>
        </div>

        <div class="divider"></div>

        <!-- ===== Contact ===== -->
        <h3 style="margin:6px 0 10px;font-weight:800;color:#0f172a">Contact</h3>
        <div class="grid">
          <div>
            <label for="nom">Nom / Entreprise *</label>
            <input id="nom" type="text" required>
          </div>
          <div>
            <label for="tel">Téléphone *</label>
            <input id="tel" type="tel" placeholder="+41 ..." required>
          </div>
          <div>
            <label for="email">E-mail *</label>
            <input id="email" type="email" placeholder="exemple@mail.ch" required>
          </div>
          <div>
            <label for="site">Site web (optionnel)</label>
            <input id="site" type="url" placeholder="https://...">
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="margin-bottom:8px">
          <span class="pill">PetBook</span>
          <span class="pill">Suisse</span>
        </div>

        <!-- Consentement -->
        <div class="consent" style="margin-bottom:8px">
          <input type="checkbox" id="cgu" required>
          <label for="cgu">J’accepte les <a href="regles.html" target="_blank" rel="noopener">Règles</a>, les <a href="cgu.html" target="_blank" rel="noopener">CGU</a> et les <a href="infos-legales.html" target="_blank" rel="noopener">informations légales</a>.</label>
        </div>

        <div class="actions" style="margin-top:14px">
          <button type="submit" class="btn primary" id="btn-submit">Publier l’annonce</button>
          <button type="button" class="btn secondary" id="btn-preview">Aperçu</button>
          <a href="annonces.html" class="btn secondary">← Retour</a>
        </div>

        <div id="status" class="status"></div>
      </form>
    </div>
  </main>

  <footer>
    <div class="container footgrid">
      <div>
        <div class="title" style="font-weight:800">PetBook</div>
        <p class="muted">Plateforme suisse pour animaux</p>
      </div>
      <div>
        <div class="title" style="font-weight:800">Contact</div>
        <p class="muted"><a href="mailto:petbookswiss@gmail.com">petbookswiss@gmail.com</a></p>
      </div>
    </div>
    <div class="container copy">© PetBook — Tous droits réservés.</div>
  </footer>

  <script>
    // ===== Auth Netlify Identity (facultatif)
    (function(){
      const loginBtn   = document.getElementById('btn-login');
      const logoutBtn  = document.getElementById('btn-logout');
      const accountLnk = document.getElementById('link-account');
      function show(el){ el.classList.remove('hidden'); }
      function hide(el){ el.classList.add('hidden'); }
      if(typeof netlifyIdentity!=='undefined'){
        loginBtn.addEventListener('click', () => netlifyIdentity.open('login'));
        logoutBtn.addEventListener('click', () => netlifyIdentity.logout());
        function refreshUI(user){ if(user){ hide(loginBtn); show(logoutBtn); show(accountLnk);} else { show(loginBtn); hide(logoutBtn); hide(accountLnk);} }
        netlifyIdentity.on('init', refreshUI);
        netlifyIdentity.on('login', (user)=>{ refreshUI(user); netlifyIdentity.close(); window.location.href='compte.html'; });
        netlifyIdentity.on('logout', ()=>{ refreshUI(null); window.location.href='index.html'; });
        netlifyIdentity.init();
      }
    })();

    // ===== Données de sélection (même logique que précédemment)
    const typeSel = document.getElementById('type');
    const catSel  = document.getElementById('categorie');
    const famSel  = document.getElementById('famille');
    const detSel  = document.getElementById('detail');

    const labelCat = document.getElementById('label-categorie');
    const labelFam = document.getElementById('label-famille');
    const labelDet = document.getElementById('label-detail');
    const hintCat  = document.getElementById('hint-categorie');
    const hintFam  = document.getElementById('hint-famille');
    const hintDet  = document.getElementById('hint-detail');

    const CATS_VA = ["Animaux de compagnie","Animaux de ferme (agriculture)"];
    const FAMS_VA = {
      "Animaux de compagnie": ["Chien","Chat","Rongeurs/Lapins","Oiseaux","Reptiles","Poissons","Chevaux","Autres"],
      "Animaux de ferme (agriculture)": ["Bovin","Ovin","Caprin","Volaille","Apiculture","Autres"]
    };
    const CATS_ACC = ["Accessoires animaux de compagnie","Accessoires animaux d’élevage"];
    const FAMS_ACC = {
      "Accessoires animaux de compagnie": ["Chien","Chat","Rongeurs/Lapins","Oiseaux","Reptiles","Poissons","Chevaux"],
      "Accessoires animaux d’élevage": ["Bovin","Ovin","Caprin","Volaille","Apiculture"]
    };
    const DETS_ACC = {
      "Chien": ["Laisse/Collier","Gamelles/Distributeurs","Jouets","Niches/Couchages","Transport/Cages","Autres"],
      "Chat": ["Arbres/Griffoirs","Litières/Bacs","Jouets","Couchages","Nourriture/Gamelles","Autres"],
      "Rongeurs/Lapins": ["Cages","Litières","Jeux/Tunnels","Divers"],
      "Oiseaux": ["Cages/Volières","Perchoirs/Nids","Jouets","Nourriture/Distributeurs","Autres"],
      "Reptiles": ["Terrariums","Chauffage/Lampe UV","Décor/Substrat","Autres"],
      "Poissons": ["Aquarium complet","Pompe/Filtre","Plantes/Décor","Nourriture/Entretien","Autres"],
      "Chevaux": ["Sellerie/Harnais","Équipements d’écurie","Couvertures/Protections","Transport","Autres"],
      "Bovin": ["Contention","Distributeurs","Clôtures/Enclos","Abreuvoirs/Auges","Autres"],
      "Ovin": ["Contention","Distributeurs","Clôtures/Enclos","Abreuvoirs/Auges","Autres"],
      "Caprin": ["Contention","Distributeurs","Clôtures/Enclos","Abreuvoirs/Auges","Autres"],
      "Volaille": ["Mangeoires/Abreuvoirs","Lampes chauffantes","Filets/Clôtures","Pondoirs","Autres"],
      "Apiculture": ["Ruches","Extraction","Protection","Autres"]
    };
    const CATS_SVC = ["Soins & santé","Garde & promenade","Transport & hébergement","Reproduction & élevage","Éducation & comportement","Autres services"];
    const FAMS_SVC = {
      "Soins & santé": ["Toiletteur","Vétérinaire","Ostéo/Physio animalier","Nutritionniste"],
      "Garde & promenade": ["Promenade de chien","Garde d’animaux / Pet sitter","Pension / Hébergement"],
      "Transport & hébergement": ["Taxi animalier / Transport"],
      "Reproduction & élevage": ["Saillie / Reproduction","Élevage professionnel agréé","Équitation / Écurie de pension"],
      "Éducation & comportement": ["Comportementaliste / Éducateur canin","Dresseur spécialisé"],
      "Autres services": ["Photographe animalier / Créateur de contenu"]
    };

    function setOptions(select, list, placeholder){
      select.innerHTML = '';
      if (!list || !list.length){
        select.innerHTML = `<option value="" disabled selected>${placeholder||"—"}</option>`;
        select.disabled = true;
        return;
      }
      list.forEach((name,i)=>{
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        if(i===0) opt.selected = true;
        select.appendChild(opt);
      });
      select.disabled = false;
    }

    function setLabelsForType(){
      if (typeSel.value === 'Vente/Adoption'){
        labelCat.textContent = 'Catégorie (Niveau 1) *';
        labelFam.textContent = 'Espèce (Niveau 2) *';
        labelDet.textContent = 'Accessoire (Niveau 3)';
        hintCat.textContent = 'Ex. Animaux de compagnie ou Animaux de ferme.';
        hintFam.textContent = 'Ex. Chien / Chat / Bovin / Apiculture…';
        hintDet.textContent = 'Non applicable pour Vente / Adoption.';
        setOptions(detSel, [], 'Non applicable');
      }
      if (typeSel.value === 'Accessoires'){
        labelCat.textContent = 'Catégorie (Niveau 1) *';
        labelFam.textContent = 'Espèce (Niveau 2) *';
        labelDet.textContent = 'Accessoire (Niveau 3)';
        hintCat.textContent = 'Ex. Accessoires animaux de compagnie ou d’élevage.';
        hintFam.textContent = 'Choisissez l’espèce concernée (ex. Chien, Bovin…).';
        hintDet.textContent = 'Choisissez l’accessoire (ex. Niches, Ruches, etc.).';
      }
      if (typeSel.value === 'Services'){
        labelCat.textContent = 'Domaine (Niveau 1) *';
        labelFam.textContent = 'Service (Niveau 2) *';
        labelDet.textContent = 'Accessoire (Niveau 3)';
        hintCat.textContent = 'Ex. Soins & santé, Garde & promenade, etc.';
        hintFam.textContent = 'Ex. Toiletteur, Vétérinaire, Photographe…';
        hintDet.textContent = 'Non applicable pour Services.';
        setOptions(detSel, [], 'Non applicable');
      }
    }

    function onTypeChange(){
      setLabelsForType();
      let cats = [];
      if (typeSel.value === 'Vente/Adoption') cats = CATS_VA;
      if (typeSel.value === 'Accessoires')    cats = CATS_ACC;
      if (typeSel.value === 'Services')       cats = CATS_SVC;
      setOptions(catSel, cats, 'Choisir une catégorie');
      onCatChange();
    }
    function onCatChange(){
      let fams = [];
      if (typeSel.value === 'Vente/Adoption') fams = FAMS_VA[catSel.value] || [];
      if (typeSel.value === 'Accessoires')    fams = FAMS_ACC[catSel.value] || [];
      if (typeSel.value === 'Services')       fams = FAMS_SVC[catSel.value] || [];
      setOptions(famSel, fams, typeSel.value==='Services'?'Choisir un service':'Choisir une espèce');
      onFamChange();
    }
    function onFamChange(){
      if (typeSel.value === 'Accessoires'){
        const dets = DETS_ACC[famSel.value] || [];
        setOptions(detSel, dets, 'Choisir un accessoire');
      } else {
        setOptions(detSel, [], 'Non applicable');
      }
    }
    typeSel.addEventListener('change', onTypeChange);
    catSel.addEventListener('change', onCatChange);
    famSel.addEventListener('change', onFamChange);

    // Prix ↔ Gratuit / Sur devis
    const prix = document.getElementById('prix');
    const gratuit = document.getElementById('gratuit');
    const surdevis = document.getElementById('surdevis');
    function syncPrix(){
      if ((gratuit && gratuit.checked) || (surdevis && surdevis.checked)){
        if(prix){ prix.value=''; prix.disabled=true; prix.placeholder='—'; }
      } else {
        if(prix){ prix.disabled=false; prix.placeholder='Ex. 250'; }
      }
    }
    gratuit.addEventListener('change', syncPrix);
    surdevis.addEventListener('change', syncPrix);
    document.addEventListener('DOMContentLoaded', syncPrix);

    // ====== Publication vers Supabase
    const statusEl = document.getElementById('status');
    function setStatus(msg, ok){
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (ok ? 'ok' : 'err');
    }

    // Clés via Netlify (variables d'env)
    const SUPABASE_URL = "{{SUPABASE_URL}}";
    const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}";
    const supabaseClient = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.getElementById('btn-preview').addEventListener('click', ()=>{
      const t = document.getElementById('title').value.trim();
      if (!t){ alert('Ajoute un titre.'); return; }
      const parts=[typeSel.value, catSel.value, famSel.value].filter(Boolean);
      if (!detSel.disabled && detSel.value) parts.push(detSel.value);
      alert(`APERÇU\n\n${t}\n${parts.join(' → ')}`);
    });

    document.getElementById('annonce-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setStatus('Envoi en cours…', true);

      // contrôles simples
      if(!typeSel.value){ setStatus('Choisis le type d’annonce.', false); return; }
      if(!catSel.value || catSel.disabled){ setStatus('Choisis la catégorie.', false); return; }
      if(!famSel.value || famSel.disabled){ setStatus('Choisis l’espèce / famille.', false); return; }

      // préparation des champs
      const record = {
        titre: document.getElementById('title').value.trim(),
        description: document.getElementById('desc').value.trim(),
        prix: (prix.disabled || !prix.value) ? null : Number(prix.value),
        categorie: catSel.value,
        sous_categorie: famSel.value + ((!detSel.disabled && detSel.value) ? (' > '+detSel.value) : ''),
        lieu: document.getElementById('lieu').value.trim() + ' (' + document.getElementById('canton').value + ')',
        contact_email: document.getElementById('email').value.trim(),
        contact_tel: document.getElementById('tel').value.trim(),
        type: typeSel.value,
        race: (document.getElementById('race').value.trim() || null),
        age: (document.getElementById('age').value.trim() || null),
        video: (document.getElementById('video').value.trim() || null),
        site_web: (document.getElementById('site').value.trim() || null),
        gratuit: !!(gratuit && gratuit.checked),
        sur_devis: !!(surdevis && surdevis.checked),
        // statut par défaut côté DB (si tu as une colonne): "en_attente"
      };

      try{
        const { data, error } = await supabaseClient
          .from('annonces')
          .insert(record)
          .select('id')
          .single();

        if(error) throw error;

        setStatus('✅ Annonce enregistrée. Elle apparaîtra après vérification.', true);
        // Rediriger vers la liste (ou page merci)
        setTimeout(()=>{ window.location.href = 'annonces.html'; }, 800);

      }catch(err){
        console.error(err);
        setStatus('❌ Erreur lors de la publication : ' + (err.message || err), false);
      }
    });
  </script>
</body>
</html>